name: Build & Push Docker Images

on:
  push:
    branches:
      - master

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  TEAMS_WEBHOOK: ${{ secrets.TEAMS_WEBHOOK }}

jobs:
  # 1ï¸âƒ£ Customers
  build-customers:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ” Docker Login
        run: |
          echo "${{ env.DOCKERHUB_PASSWORD }}" | docker login -u "${{ env.DOCKERHUB_USERNAME }}" --password-stdin

      - name: ğŸ“¦ Build & Push Customers
        run: |
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/customers:latest ./customers
          docker push ${{ env.DOCKERHUB_USERNAME }}/customers:latest

  # 2ï¸âƒ£ Orders
  build-orders:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ” Docker Login
        run: |
          echo "${{ env.DOCKERHUB_PASSWORD }}" | docker login -u "${{ env.DOCKERHUB_USERNAME }}" --password-stdin

      - name: ğŸ“¦ Build & Push Orders
        run: |
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/orders:latest ./orders
          docker push ${{ env.DOCKERHUB_USERNAME }}/orders:latest

  # 3ï¸âƒ£ Products
  build-products:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ” Docker Login
        run: |
          echo "${{ env.DOCKERHUB_PASSWORD }}" | docker login -u "${{ env.DOCKERHUB_USERNAME }}" --password-stdin

      - name: ğŸ“¦ Build & Push Products
        run: |
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/products:latest ./products
          docker push ${{ env.DOCKERHUB_USERNAME }}/products:latest

  # âœ… 4ï¸âƒ£ Notification Teams
  notify-teams:
    runs-on: ubuntu-latest
    needs: [build-customers, build-orders, build-products]
    if: success()

    steps:
      - name: ğŸ“£ Envoyer notification Teams
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "@type": "MessageCard",
                 "@context": "http://schema.org/extensions",
                 "summary": "DÃ©ploiement rÃ©ussi",
                 "title": "ğŸš€ Nouveau dÃ©ploiement terminÃ©",
                 "text": "Les images Docker des microservices (Customers, Orders, Products) sont prÃªtes sur Docker Hub."
               }' \
               "${{ env.TEAMS_WEBHOOK }}"
